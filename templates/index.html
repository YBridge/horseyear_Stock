<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•è‚¡åˆ†æ - ç¾è‚¡AIåˆ†æç³»ç»Ÿ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 100%);
            color: #e4e6eb;
            min-height: 100vh;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { text-align: center; margin-bottom: 30px; }
        .header h1 {
            font-size: 2em;
            background: linear-gradient(90deg, #00d4ff, #7b2cbf);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }
        .header p { color: #888; }
        .search-box { margin-bottom: 30px; text-align: center; }
        .search-box input {
            width: 100%;
            max-width: 400px;
            padding: 15px 20px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 15px;
            color: #fff;
            font-size: 16px;
            outline: none;
        }
        .search-box input:focus { border-color: #00d4ff; box-shadow: 0 0 20px rgba(0,212,255,0.2); }
        .search-box { display: flex; justify-content: center; align-items: center; gap: 10px; }
        .analyze-btn {
            padding: 15px 30px;
            background: linear-gradient(135deg, #00d4ff, #7b2cbf);
            border: none;
            border-radius: 15px;
            color: #fff;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        .analyze-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(0,212,255,0.3); }
        .tabs { display: flex; justify-content: center; gap: 15px; margin-bottom: 30px; }
        .tab {
            padding: 15px 30px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 25px;
            color: #888;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }
        .tab:hover { color: #00d4ff; background: rgba(0,212,255,0.1); }
        .tab.active { color: #00d4ff; background: rgba(0,212,255,0.2); border-color: rgba(0,212,255,0.3); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .expert-panel {
            background: linear-gradient(135deg, rgba(0,212,255,0.05) 0%, rgba(124,58,237,0.05) 100%);
            border: 1px solid rgba(0,212,255,0.2);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
        }
        .expert-action { text-align: center; margin-bottom: 25px; }
        .action-badge {
            display: inline-block;
            padding: 15px 40px;
            border-radius: 30px;
            font-size: 24px;
            font-weight: bold;
        }
        .expert-scores {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 25px;
        }
        .score-item {
            background: rgba(0,0,0,0.2);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }
        .score-item .label { font-size: 13px; color: #888; margin-bottom: 8px; }
        .score-item .value { font-size: 28px; font-weight: bold; }
        .trade-plan {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 25px;
        }
        .trade-item {
            background: rgba(255,255,255,0.05);
            padding: 20px;
            border-radius: 12px;
        }
        .trade-item .label { font-size: 13px; color: #888; margin-bottom: 8px; display: block; }
        .trade-item .value { font-size: 22px; font-weight: bold; }
        .trade-item .value.highlight { color: #00d4ff; }
        .trade-item .value.danger { color: #ef4444; }
        .trade-item .value.success { color: #22c55e; }
        .recommendation-box {
            background: rgba(255,215,0,0.1);
            border-left: 4px solid #ffd700;
            padding: 25px;
            margin-top: 25px;
            border-radius: 0 12px 12px 0;
        }
        .recommendation-box .title { font-weight: bold; color: #ffd700; margin-bottom: 12px; font-size: 16px; }
        .recommendation-box .text { font-size: 16px; line-height: 1.6; }
        .catalysts { margin-top: 20px; }
        .catalysts .title { font-size: 13px; color: #888; margin-bottom: 10px; }
        .catalysts .list { display: flex; flex-wrap: wrap; gap: 8px; }
        .catalysts .item { background: rgba(255,255,255,0.1); padding: 6px 14px; border-radius: 15px; font-size: 13px; }

        .watchlist-manager { background: rgba(255,255,255,0.03); border-radius: 16px; padding: 25px; margin-bottom: 25px; }
        .watchlist-manager h3 { color: #00d4ff; margin-bottom: 15px; }
        .input-group { display: flex; gap: 15px; margin-bottom: 20px; }
        .input-group input {
            flex: 1;
            padding: 12px 20px;
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            background: rgba(0,0,0,0.3);
            color: #fff;
            font-size: 15px;
        }
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-primary {
            background: linear-gradient(135deg, #00d4ff, #7b2cbf);
            color: #fff;
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(0,212,255,0.3); }
        .current-watchlist { display: flex; flex-wrap: wrap; gap: 12px; }
        .watchlist-tag {
            background: rgba(0,212,255,0.15);
            padding: 10px 18px;
            border-radius: 25px;
            font-size: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .watchlist-tag .remove { cursor: pointer; color: #ff6b6b; font-weight: bold; font-size: 18px; }

        .comparison-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 25px; }
        .stock-card {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 25px;
            transition: all 0.3s;
        }
        .stock-card:hover { transform: translateY(-5px); box-shadow: 0 10px 40px rgba(0,0,0,0.3); }
        .stock-card.rank-1 { border-color: #ffd700; box-shadow: 0 0 30px rgba(255,215,0,0.2); }
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
        .card-header .symbol { font-size: 28px; font-weight: bold; }
        .card-header .rank { font-size: 16px; font-weight: bold; color: #ffd700; }
        .action-badge {
            display: inline-block;
            padding: 8px 18px;
            border-radius: 20px;
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 15px;
        }
        .price-info { margin-bottom: 15px; }
        .price-info .current-price { font-size: 36px; font-weight: bold; }
        .price-info .change { font-size: 18px; margin-left: 10px; }
        .price-info .change.positive { color: #00c853; }
        .price-info .change.negative { color: #ff5252; }
        .metrics { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 15px; }
        .metric { background: rgba(0,0,0,0.2); padding: 12px; border-radius: 10px; }
        .metric .label { font-size: 11px; color: #888; }
        .metric .value { font-size: 16px; font-weight: bold; }
        .recommendation {
            background: rgba(255,215,0,0.1);
            border-left: 3px solid #ffd700;
            padding: 15px;
            margin-top: 15px;
            border-radius: 0 8px 8px 0;
        }
        .recommendation .title { font-weight: bold; color: #ffd700; margin-bottom: 8px; font-size: 14px; }
        .recommendation .text { font-size: 14px; line-height: 1.5; }

        .strategies-list { display: flex; flex-direction: column; gap: 15px; }
        .strategy-card {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px;
            padding: 20px;
            display: grid;
            grid-template-columns: auto auto auto;
            gap: 20px;
            align-items: center;
        }
        .strategy-card .symbol-box .symbol { font-size: 22px; font-weight: bold; }
        .strategy-card .symbol-box .date { font-size: 12px; color: #888; margin-top: 4px; }
        .strategy-card .action-box .action { padding: 6px 16px; border-radius: 20px; font-size: 14px; font-weight: bold; margin-bottom: 5px; }
        .strategy-card .price-box .entry { font-size: 17px; font-weight: bold; color: #00d4ff; }
        .strategy-card .notes-box .position { font-size: 14px; color: #ffd700; margin-bottom: 5px; }
        .strategy-card .delete-btn {
            padding: 8px 16px;
            background: rgba(255,82,82,0.2);
            border: 1px solid rgba(255,82,82,0.5);
            border-radius: 8px;
            color: #ff5252;
            cursor: pointer;
        }

        .loading { text-align: center; padding: 60px; color: #888; }
        .spinner {
            border: 4px solid rgba(255,255,255,0.1);
            border-top-color: #00d4ff;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .best-action {
            background: linear-gradient(135deg, rgba(0,212,255,0.2), rgba(123,44,191,0.2));
            border: 1px solid rgba(0,212,255,0.3);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
        }
        .best-action h2 { color: #00d4ff; margin-bottom: 15px; }
        .best-action .action { font-size: 28px; font-weight: bold; margin: 20px 0; }
        .best-action .details { font-size: 16px; color: #aaa; line-height: 1.6; }

        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š å•è‚¡åˆ†æ</h1>
            <p>AI æ·±åº¦åˆ†æ Â· ä¸“å®¶çº§å†³ç­– Â· åŒä½“ç³»è¯„ä¼°</p>
        </div>

        <div class="search-box">
            <input type="text" id="symbolInput" placeholder="è¾“å…¥è‚¡ç¥¨ä»£ç ï¼ˆå¦‚ï¼šAAPL, NVDA, TSLAï¼‰" onkeypress="if(event.key==='Enter') analyzeSingleStock()">
            <button class="analyze-btn" onclick="analyzeSingleStock()">ğŸ” åˆ†æ</button>
        </div>

        <!-- æ ‡ç­¾é¡µ -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('single')">ğŸ“Š è‚¡ç¥¨åˆ†æ</button>
            <button class="tab" onclick="switchTab('compare')">ğŸ¯ å…³æ³¨å¯¹æ¯”</button>
            <button class="tab" onclick="switchTab('strategies')">ğŸ“ ç­–ç•¥å†å²</button>
            <button class="tab" onclick="window.location.href='/ai_stocks'">ğŸ¤– AIæŠ•èµ„</button>
            <button class="tab" onclick="window.location.href='/market_outlook'">ğŸŒ å¸‚åœºå‰ç»</button>
        </div>

        <!-- å•è‚¡åˆ†æ -->
        <div id="tab-single" class="tab-content active">
            <div id="analyzeContent">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>è¾“å…¥è‚¡ç¥¨ä»£ç å¼€å§‹åˆ†æ...</p>
                </div>
            </div>
        </div>

        <!-- å…³æ³¨å¯¹æ¯” -->
        <div id="tab-compare" class="tab-content">
            <div class="watchlist-manager">
                <h3>ğŸ“‹ ç®¡ç†å…³æ³¨åˆ—è¡¨</h3>
                <div class="input-group">
                    <input type="text" id="watchlistInput" placeholder="è¾“å…¥è‚¡ç¥¨ä»£ç ï¼ˆå¦‚ï¼šAAPL, NVDA, TSLAï¼‰">
                    <button class="btn btn-primary" onclick="addToWatchlist()">æ·»åŠ </button>
                    <button class="btn btn-primary" onclick="analyzeWatchlist()">åˆ·æ–°åˆ†æ</button>
                </div>
                <div class="current-watchlist" id="watchlistTags"></div>
            </div>

            <div class="best-action" id="bestAction" style="display:none;">
                <h2>ğŸ† æœ€ä½³æ“ä½œå»ºè®®</h2>
                <div class="action" id="bestActionText"></div>
                <div class="details" id="bestActionDetails"></div>
            </div>

            <div class="loading" id="watchlistLoading" style="display:none;">
                <div class="spinner"></div>
                <p>æ­£åœ¨åˆ†æå…³æ³¨åˆ—è¡¨...</p>
            </div>

            <div class="comparison-grid" id="comparisonGrid"></div>
        </div>

        <!-- ç­–ç•¥å†å² -->
        <div id="tab-strategies" class="tab-content">
            <div id="strategiesContent">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>åŠ è½½ç­–ç•¥å†å²...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let watchlist = [];
        let stockData = [];

        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('tab-' + tabName).classList.add('active');

            if (tabName === 'compare') {
                loadWatchlist();
            } else if (tabName === 'strategies') {
                loadStrategies();
            }
        }

        // å•è‚¡åˆ†æ
        async function analyzeSingleStock() {
            const symbol = document.getElementById('symbolInput').value.trim().toUpperCase();
            if (!symbol) return;

            const content = document.getElementById('analyzeContent');
            content.innerHTML = '<div class="loading"><div class="spinner"></div><p>æ­£åœ¨åˆ†æ ' + symbol + '...</p></div>';

            try {
                const response = await fetch('/get_all_data', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({symbol})
                });
                const data = await response.json();

                if (!data.success) {
                    content.innerHTML = '<p style="color:#ff6b6b;">é”™è¯¯: ' + data.error + '</p>';
                    return;
                }

                // ä¿å­˜åˆ†æç»“æœç”¨äºç­–ç•¥ä¿å­˜
                currentAnalysisData = data.expert;
                stockData = [data.data];

                renderExpertAnalysis(data.data, data.expert);
            } catch (error) {
                console.error('åˆ†æå¤±è´¥:', error);
                content.innerHTML = '<p style="color:#ff6b6b;">åˆ†æå¤±è´¥: ' + error.message + '</p>';
            }
        }

        function renderExpertAnalysis(data, expert) {
            const content = document.getElementById('analyzeContent');

            try {
                const decision = expert.decision || {};
                const fundamental = expert.fundamental || {};
                const technical = expert.technical || {};

                // è¯„åˆ†é¢œè‰²
                const getScoreColor = (score) => {
                    if (score >= 80) return '#00c853';
                    if (score >= 60) return '#64dd17';
                    if (score >= 40) return '#ffd600';
                    return '#ff5252';
                };

                content.innerHTML = `
                <style>
                    .analysis-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
                    .analysis-card { background: rgba(255,255,255,0.03); border-radius: 16px; padding: 25px; border: 1px solid rgba(255,255,255,0.1); }
                    .analysis-card h3 { color: #00d4ff; margin-bottom: 20px; font-size: 18px; display: flex; align-items: center; gap: 10px; }
                    .analysis-card h3 .score { margin-left: auto; padding: 5px 15px; border-radius: 20px; font-size: 14px; font-weight: bold; }
                    .metric-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
                    .metric-row:last-child { border-bottom: none; }
                    .metric-label { color: #888; font-size: 14px; }
                    .metric-value { font-weight: bold; font-size: 15px; }
                    .decision-panel { background: linear-gradient(135deg, rgba(0,212,255,0.1), rgba(123,58,237,0.1)); border-radius: 20px; padding: 30px; margin-bottom: 25px; text-align: center; }
                    .decision-badge { display: inline-block; padding: 15px 40px; border-radius: 30px; font-size: 28px; font-weight: bold; margin-bottom: 20px; }
                    .decision-scores { display: flex; justify-content: center; gap: 40px; margin-bottom: 25px; }
                    .decision-score-item { text-align: center; }
                    .decision-score-item .label { font-size: 13px; color: #888; margin-bottom: 5px; }
                    .decision-score-item .value { font-size: 24px; font-weight: bold; }
                    .trade-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 20px; }
                    .trade-box { background: rgba(0,0,0,0.2); padding: 15px; border-radius: 12px; }
                    .trade-box .label { font-size: 12px; color: #888; margin-bottom: 5px; }
                    .trade-box .value { font-size: 18px; font-weight: bold; }
                    .factors-list { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 15px; }
                    .factors-list .item { background: rgba(255,255,255,0.1); padding: 6px 14px; border-radius: 15px; font-size: 13px; }
                    .sub-metrics { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 15px; }
                    .sub-metric { background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px; text-align: center; }
                    .sub-metric .name { font-size: 11px; color: #888; }
                    .sub-metric .score { font-size: 16px; font-weight: bold; margin-top: 3px; }
                    @media (max-width: 768px) {
                        .analysis-grid { grid-template-columns: 1fr; }
                        .trade-grid { grid-template-columns: repeat(2, 1fr); }
                    }
                </style>

                <!-- å†³ç­–é¢æ¿ -->
                <div class="decision-panel">
                    <div class="decision-badge" style="background:${decision.action_color || '#888'};color:#fff;">
                        ${decision.action || 'åˆ†æä¸­'}
                    </div>
                    <div style="color:#aaa;margin-bottom:20px;">ä¿¡å¿ƒçº§åˆ«: ${decision.confidence || 'N/A'}</div>

                    <div class="decision-scores">
                        <div class="decision-score-item">
                            <div class="label">ç»¼åˆè¯„åˆ†</div>
                            <div class="value" style="color:${getScoreColor(decision.comprehensive_score || 0)}">${decision.comprehensive_score || 0}</div>
                        </div>
                        <div class="decision-score-item">
                            <div class="label">åŸºæœ¬é¢ (ç†æ€§)</div>
                            <div class="value" style="color:${getScoreColor(decision.fundamental_score || 0)}">${decision.fundamental_score || 0}</div>
                        </div>
                        <div class="decision-score-item">
                            <div class="label">æŠ€æœ¯é¢ (æƒ…ç»ª)</div>
                            <div class="value" style="color:${getScoreColor(decision.technical_score || 0)}">${decision.technical_score || 0}</div>
                        </div>
                    </div>

                    <div class="trade-grid">
                        <div class="trade-box">
                            <div class="label">ğŸ’° å…¥åœºä»·æ ¼</div>
                            <div class="value" style="color:#00d4ff;">$${decision.entry_price || data.price}</div>
                        </div>
                        <div class="trade-box">
                            <div class="label">ğŸ¯ ç›®æ ‡ä»·æ ¼</div>
                            <div class="value" style="color:#00c853;">$${decision.target_price || '-'}</div>
                        </div>
                        <div class="trade-box">
                            <div class="label">ğŸ›‘ æ­¢æŸä»·æ ¼</div>
                            <div class="value" style="color:#ff5252;">$${decision.stop_loss || '-'}</div>
                        </div>
                        <div class="trade-box">
                            <div class="label">ğŸ“Š å»ºè®®ä»“ä½</div>
                            <div class="value">${decision.position || '-'}</div>
                        </div>
                        <div class="trade-box">
                            <div class="label">â° æ—¶é—´å‘¨æœŸ</div>
                            <div class="value">${decision.time_horizon || '-'}</div>
                        </div>
                        <div class="trade-box">
                            <div class="label">âš ï¸ é£é™©ç­‰çº§</div>
                            <div class="value">${decision.risk_level || '-'}</div>
                        </div>
                    </div>

                    <div style="margin-top:25px;text-align:left;">
                        <div style="color:#ffd700;margin-bottom:10px;">ğŸ”¥ å…³é”®å‚¬åŒ–å‰‚</div>
                        <div class="factors-list">
                            ${(decision.catalysts || []).map(c => `<span class="item">${c}</span>`).join('') || '<span style="color:#888;">æš‚æ— </span>'}
                        </div>
                    </div>

                    <div style="margin-top:20px;text-align:left;">
                        <div style="color:#ff6b6b;margin-bottom:10px;">âš ï¸ é£é™©å› ç´ </div>
                        <div class="factors-list">
                            ${(decision.risk_factors || []).map(r => `<span class="item">${r}</span>`).join('') || '<span style="color:#888;">æš‚æ— </span>'}
                        </div>
                    </div>
                </div>

                <!-- åŒåˆ†æç³»ç»Ÿ -->
                <div class="analysis-grid">
                    <!-- åŸºæœ¬é¢åˆ†æ -->
                    <div class="analysis-card">
                        <h3>
                            ğŸ“Š åŸºæœ¬é¢åˆ†æ (ç†æ€§)
                            <span class="score" style="background:${getScoreColor(fundamental.total_score || 0)};color:#fff;">${fundamental.total_score || 0}/100</span>
                        </h3>
                        <p style="color:#aaa;font-size:14px;margin-bottom:20px;">${fundamental.summary || 'æš‚æ— åˆ†æ'}</p>

                        <div class="sub-metrics">
                            <div class="sub-metric">
                                <div class="name">ä¼°å€¼</div>
                                <div class="score">${(fundamental.scores && fundamental.scores.valuation) || 0}/20</div>
                            </div>
                            <div class="sub-metric">
                                <div class="name">ç›ˆåˆ©</div>
                                <div class="score">${(fundamental.scores && fundamental.scores.profitability) || 0}/20</div>
                            </div>
                            <div class="sub-metric">
                                <div class="name">æˆé•¿</div>
                                <div class="score">${(fundamental.scores && fundamental.scores.growth) || 0}/20</div>
                            </div>
                            <div class="sub-metric">
                                <div class="name">è´¢åŠ¡</div>
                                <div class="score">${(fundamental.scores && fundamental.scores.financial_health) || 0}/20</div>
                            </div>
                        </div>

                        <div style="margin-top:20px;">
                            <div class="metric-row">
                                <span class="metric-label">ä¼°å€¼æ°´å¹³</span>
                                <span class="metric-value">${(fundamental.details && fundamental.details.valuation && fundamental.details.valuation.analysis) || '-'}</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">å¸‚ç›ˆç‡ PE</span>
                                <span class="metric-value">${data.pe_ratio || '-'}</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">è¥æ”¶å¢é•¿</span>
                                <span class="metric-value">${(fundamental.details && fundamental.details.growth && fundamental.details.growth.revenue_growth) || 0}%</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">ROE</span>
                                <span class="metric-value">${(fundamental.details && fundamental.details.profitability && fundamental.details.profitability.roe) || 0}%</span>
                            </div>
                        </div>
                    </div>

                    <!-- æŠ€æœ¯é¢åˆ†æ -->
                    <div class="analysis-card">
                        <h3>
                            ğŸ“ˆ æŠ€æœ¯é¢åˆ†æ (æƒ…ç»ª)
                            <span class="score" style="background:${getScoreColor(technical.total_score || 0)};color:#fff;">${technical.total_score || 0}/100</span>
                        </h3>
                        <p style="color:#aaa;font-size:14px;margin-bottom:20px;">${technical.summary || 'æš‚æ— åˆ†æ'}</p>

                        <div class="sub-metrics">
                            <div class="sub-metric">
                                <div class="name">è¶‹åŠ¿</div>
                                <div class="score">${(technical.scores && technical.scores.trend) || 0}/25</div>
                            </div>
                            <div class="sub-metric">
                                <div class="name">åŠ¨é‡</div>
                                <div class="score">${(technical.scores && technical.scores.momentum) || 0}/25</div>
                            </div>
                            <div class="sub-metric">
                                <div class="name">RSI</div>
                                <div class="score">${(technical.scores && technical.scores.rsi) || 0}/25</div>
                            </div>
                            <div class="sub-metric">
                                <div class="name">ç‚¹ä½</div>
                                <div class="score">${(technical.scores && technical.scores.levels) || 0}/25</div>
                            </div>
                        </div>

                        <div style="margin-top:20px;">
                            <div class="metric-row">
                                <span class="metric-label">å½“å‰è¶‹åŠ¿</span>
                                <span class="metric-value">${(technical.details && technical.details.trend && technical.details.trend.current_trend) || '-'}</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">RSI æ°´å¹³</span>
                                <span class="metric-value">${(technical.details && technical.details.rsi && technical.details.rsi.level) || '-'} (${data.rsi || 0})</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">æ”¯æ’‘ä½</span>
                                <span class="metric-value" style="color:#00c853;">$${data.support || '-'}</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">é˜»åŠ›ä½</span>
                                <span class="metric-value" style="color:#ff5252;">$${data.resistance || '-'}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div style="text-align:center;margin-top:25px;">
                    <button class="btn btn-primary" onclick="saveStrategy('${data.symbol}')" style="padding:15px 35px;font-size:16px;">
                        ğŸ’¾ ä¿å­˜ä¸ºç­–ç•¥
                    </button>
                </div>

                <!-- AI æ·±åº¦åˆ†ææ ‡ç­¾é¡µ -->
                <div style="margin-top:30px;">
                    <div style="display:flex;justify-content:center;gap:10px;margin-bottom:20px;flex-wrap:wrap;">
                        <button class="ai-tab-btn active" onclick="loadAIAnalysis('overview', this)" style="padding:10px 20px;background:rgba(0,212,255,0.2);border:1px solid rgba(0,212,255,0.3);border-radius:20px;color:#00d4ff;cursor:pointer;">ğŸ“Š å…¨é¢æ¦‚è§ˆ</button>
                        <button class="ai-tab-btn" onclick="loadAIAnalysis('technical', this)" style="padding:10px 20px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:20px;color:#888;cursor:pointer;">ğŸ“ˆ æŠ€æœ¯é¢åˆ†æ</button>
                        <button class="ai-tab-btn" onclick="loadAIAnalysis('news', this)" style="padding:10px 20px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:20px;color:#888;cursor:pointer;">ğŸ“° æœ€æ–°åŠ¨æ€</button>
                        <button class="ai-tab-btn" onclick="loadAIAnalysis('target', this)" style="padding:10px 20px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:20px;color:#888;cursor:pointer;">ğŸ¯ ç›®æ ‡ä»·åˆ†æ</button>
                    </div>
                    <div id="aiAnalysisContent" style="background:rgba(0,0,0,0.2);border-radius:15px;padding:20px;min-height:200px;white-space:pre-line;line-height:1.8;">
                        æ­£åœ¨åŠ è½½ AI æ·±åº¦åˆ†æ...
                    </div>
                </div>
            `;
            } catch (error) {
                console.error('æ¸²æŸ“åˆ†æå‡ºé”™:', error);
                content.innerHTML = `
                    <div class="expert-panel" style="padding:30px;text-align:center;">
                        <p style="color:#ff6b6b;margin-bottom:15px;">åˆ†ææ•°æ®åŠ è½½å¤±è´¥</p>
                        <p style="color:#888;font-size:14px;">é”™è¯¯ä¿¡æ¯: ${error.message}</p>
                        <button class="btn btn-primary" onclick="analyzeSingleStock()" style="margin-top:20px;">é‡è¯•</button>
                    </div>
                `;
            }
        }

        // å…³æ³¨åˆ—è¡¨
        async function loadWatchlist() {
            const response = await fetch('/get_watchlist');
            const data = await response.json();
            watchlist = data.watchlist || [];
            renderWatchlistTags();
        }

        function renderWatchlistTags() {
            const container = document.getElementById('watchlistTags');
            container.innerHTML = watchlist.map(s => `
                <span class="watchlist-tag">
                    ${s}
                    <span class="remove" onclick="removeFromWatchlist('${s}')">Ã—</span>
                </span>
            `).join('');
        }

        async function addToWatchlist() {
            const input = document.getElementById('watchlistInput');
            const symbols = input.value.split(',').map(s => s.trim().toUpperCase()).filter(s => s);
            input.value = '';

            const response = await fetch('/update_watchlist', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({action: 'add', symbols})
            });
            const data = await response.json();
            watchlist = data.watchlist;
            renderWatchlistTags();
        }

        async function removeFromWatchlist(symbol) {
            const response = await fetch('/update_watchlist', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({action: 'remove', symbols: [symbol]})
            });
            const data = await response.json();
            watchlist = data.watchlist;
            renderWatchlistTags();
        }

        async function analyzeWatchlist() {
            document.getElementById('watchlistLoading').style.display = 'block';
            document.getElementById('comparisonGrid').innerHTML = '';
            document.getElementById('bestAction').style.display = 'none';

            const response = await fetch('/get_watchlist_data', { method: 'POST', headers: {'Content-Type': 'application/json'} });
            const data = await response.json();
            stockData = data.stocks || [];

            document.getElementById('watchlistLoading').style.display = 'none';
            renderComparison();
            if (stockData.length > 0) showBestAction();
        }

        function renderComparison() {
            const container = document.getElementById('comparisonGrid');
            container.innerHTML = stockData.map((stock, index) => {
                const rank = index + 1;
                const changeClass = stock.current_price > 0 ? 'positive' : 'neutral';
                const changeSymbol = stock.current_price > 0 ? '+' : '';
                return `
                <div class="stock-card rank-${rank}">
                    <div class="card-header">
                        <div>
                            <div class="symbol">${stock.symbol}</div>
                        </div>
                        <div class="rank">#${rank}</div>
                    </div>

                    <div class="action-badge" style="background:${stock.action_color};margin-bottom:15px;">
                        ${stock.action} Â· ${stock.action_en}
                    </div>

                    <div class="price-info">
                        <span class="current-price">$${stock.current_price?.toFixed(2) || stock.entry_price}</span>
                        <span class="change ${changeClass}">
                            ${changeSymbol}${stock.total_score?.toFixed(1)} åˆ†
                        </span>
                    </div>

                    <div class="metrics">
                        <div class="metric">
                            <div class="label">æŠ€æœ¯é¢</div>
                            <div class="value">${stock.tech_score}/10</div>
                        </div>
                        <div class="metric">
                            <div class="label">åŸºæœ¬é¢</div>
                            <div class="value">${stock.fund_score}/10</div>
                        </div>
                        <div class="metric">
                            <div class="label">å…¥åœºä»·</div>
                            <div class="value">$${stock.entry_price?.toFixed(2)}</div>
                        </div>
                        <div class="metric">
                            <div class="label">æ­¢æŸ</div>
                            <div class="value" style="color:#ff5252;">$${stock.stop_loss?.toFixed(2)}</div>
                        </div>
                    </div>

                    <div class="recommendation">
                        <div class="title">ğŸ’¡ ä¸“å®¶å»ºè®®</div>
                        <div class="text">${stock.entry_msg}</div>
                    </div>

                    <div style="margin-top:15px;">
                        <button class="btn btn-primary" style="width:100%;" onclick="saveStrategy('${stock.symbol}')">
                            ğŸ’¾ ä¿å­˜ä¸ºç­–ç•¥
                        </button>
                    </div>
                </div>
            `}).join('');
        }

        function showBestAction() {
            const best = stockData[0];
            let action = '';
            let details = '';

            if (best.total_score >= 7) {
                action = `è€ƒè™‘ä¹°å…¥ <strong>${best.symbol}</strong>`;
                details = `${best.symbol} è¯„åˆ† ${best.total_score}ï¼Œå½“å‰ä»·æ ¼ $${best.current_price?.toFixed(2)}ï¼Œå»ºè®®å…¥åœºä»· $${best.entry_price?.toFixed(2)}ã€‚ç›®æ ‡ä»· $${best.target_short?.toFixed(2)}ï¼Œæ­¢æŸ $${best.stop_loss?.toFixed(2)}ã€‚`;
            } else if (best.total_score >= 5) {
                action = `å¯æŒæœ‰ <strong>${best.symbol}</strong>`;
                details = `${best.symbol} è¯„åˆ† ${best.total_score}ï¼Œå»ºè®®ä»“ä½ ${best.position}ã€‚ç­‰å¾…æ›´å¥½çš„å…¥åœºç‚¹æˆ–ç»§ç»­æŒæœ‰ã€‚`;
            } else {
                action = `å»ºè®®è§‚æœ›`;
                details = `å…³æ³¨åˆ—è¡¨ä¸­æ‰€æœ‰è‚¡ç¥¨è¯„åˆ†å‡æœªè¶…è¿‡ 5 åˆ†ï¼Œå»ºè®®ç­‰å¾…æ›´å¥½çš„å…¥åœºæ—¶æœºã€‚`;
            }

            document.getElementById('bestActionText').innerHTML = action;
            document.getElementById('bestActionDetails').innerHTML = details;
            document.getElementById('bestAction').style.display = 'block';
        }

        // ç­–ç•¥å†å²
        async function loadStrategies() {
            const response = await fetch('/get_strategies');
            const data = await response.json();
            const strategies = data.strategies || [];

            const container = document.getElementById('strategiesContent');

            if (strategies.length === 0) {
                container.innerHTML = `
                    <div style="text-align:center;padding:60px;color:#888;">
                        <div style="font-size:48px;margin-bottom:15px;">ğŸ“­</div>
                        <p>æš‚æ— ç­–ç•¥è®°å½•</p>
                        <p style="font-size:13px;margin-top:10px;">åœ¨å…³æ³¨å¯¹æ¯”é¡µé¢åˆ†æè‚¡ç¥¨åï¼Œç‚¹å‡»"ä¿å­˜ä¸ºç­–ç•¥"å³å¯åœ¨æ­¤å¤„æŸ¥çœ‹</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="strategies-list">
                    ${strategies.map(s => `
                        <div class="strategy-card">
                            <div class="symbol-box">
                                <div class="symbol">${s.symbol}</div>
                                <div class="date">${s.created_at}</div>
                            </div>
                            <div class="action-box">
                                <div class="action" style="background:${s.action_color};color:#fff;">${s.action}</div>
                                <div class="score">${s.total_score}/10</div>
                            </div>
                            <div class="price-box">
                                <div class="label">å…¥åœºä»·</div>
                                <div class="entry">$${s.entry_price?.toFixed(2)}</div>
                                <div class="entry">ç›®æ ‡ $${s.target_short?.toFixed(2)}</div>
                            </div>
                            <div class="notes-box">
                                <div class="position">${s.position}</div>
                                <div class="risk">æ­¢æŸ $${s.stop_loss?.toFixed(2)} (${s.risk_pct}% é£é™©)</div>
                            </div>
                            <button class="delete-btn" onclick="deleteStrategy('${s.id}')">åˆ é™¤</button>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        async function deleteStrategy(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡ç­–ç•¥å—ï¼Ÿ')) return;
            await fetch('/delete_strategy', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({id})
            });
            loadStrategies();
        }

        // ä¿å­˜å½“å‰åˆ†æç»“æœ
        let currentAnalysisData = null;

        async function saveStrategy(symbol) {
            if (!currentAnalysisData || !currentAnalysisData.decision) {
                alert('è¯·å…ˆåˆ†æè‚¡ç¥¨æ•°æ®');
                return;
            }

            const decision = currentAnalysisData.decision;
            const strategy = {
                action: decision.action,
                action_en: decision.action_en,
                action_color: decision.action_color,
                total_score: decision.comprehensive_score,
                tech_score: decision.technical_score,
                fund_score: decision.fundamental_score,
                entry_price: decision.entry_price,
                stop_loss: decision.stop_loss,
                target_price: decision.target_price,
                time_horizon: decision.time_horizon,
                position: decision.position,
                risk_level: decision.risk_level,
                catalysts: decision.catalysts,
                current_price: decision.current_price,
                confidence: decision.confidence
            };

            try {
                await fetch('/save_strategy', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ symbol, strategy })
                });
                alert('âœ… ' + symbol + ' ç­–ç•¥å·²ä¿å­˜ï¼\n\nå¯åœ¨"ç­–ç•¥å†å²"æ ‡ç­¾é¡µæŸ¥çœ‹ã€‚');
            } catch (error) {
                alert('ä¿å­˜å¤±è´¥: ' + error.message);
            }
        }

        // AI æ·±åº¦åˆ†æ
        let currentAISymbol = '';
        async function loadAIAnalysis(type, btnElement) {
            if (!currentAISymbol) return;

            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.ai-tab-btn').forEach(btn => {
                btn.style.background = 'rgba(255,255,255,0.05)';
                btn.style.color = '#888';
                btn.style.borderColor = 'rgba(255,255,255,0.1)';
            });
            btnElement.style.background = 'rgba(0,212,255,0.2)';
            btnElement.style.color = '#00d4ff';
            btnElement.style.borderColor = 'rgba(0,212,255,0.3)';

            const contentDiv = document.getElementById('aiAnalysisContent');
            contentDiv.textContent = 'AI æ­£åœ¨åˆ†æä¸­...';

            try {
                const response = await fetch('/ai_analysis', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({symbol: currentAISymbol, type: type})
                });
                const data = await response.json();

                if (data.success) {
                    contentDiv.textContent = data.analysis;
                } else {
                    contentDiv.textContent = 'åˆ†æå¤±è´¥: ' + data.error;
                }
            } catch (error) {
                contentDiv.textContent = 'ç½‘ç»œé”™è¯¯: ' + error.message;
            }
        }

        // æ›´æ–° analyzeSingleStock å‡½æ•°ä»¥ä¿å­˜å½“å‰åˆ†æçš„è‚¡ç¥¨ä»£ç 
        const originalAnalyzeSingleStock = analyzeSingleStock;
        analyzeSingleStock = async function() {
            const symbol = document.getElementById('symbolInput').value.trim().toUpperCase();
            if (!symbol) {
                alert('è¯·è¾“å…¥è‚¡ç¥¨ä»£ç ');
                return;
            }
            currentAISymbol = symbol;
            await originalAnalyzeSingleStock();
            // è‡ªåŠ¨åŠ è½½ç¬¬ä¸€ä¸ª AI åˆ†ææ ‡ç­¾
            setTimeout(() => {
                const firstTab = document.querySelector('.ai-tab-btn');
                if (firstTab) {
                    loadAIAnalysis('overview', firstTab);
                }
            }, 1000);
        };

        // åˆå§‹åŒ–
        loadWatchlist();
    </script>
</body>
</html>
